// Response for Uptime Robot
const http = require("http");
http
  .createServer(function(request, response) {
    response.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
    response.end("Discord bot ã¯ å‹•ã„ã¦ã„ã¾ã™\n");
  })
  .listen(3000);

// Discord bot implements
const discord = require("discord.js");
const client = new discord.Client();
const Eris = require("eris");
const bot = new Eris(process.env.DISCORD_BOT_TOKEN);

var args = 0;
var command = 0;

const prefix = "$";
const { RichEmbed } = require("discord.js");
var setroomid = null; // DefaultRoomID
var ReactuserList = []; // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼

var RcheckOn = false;

client.on("ready", message => {
  client.user.setActivity("å·ã‚‰ãªã„æ—¥ã€…", { type: "LISTENING" });
  //  console.log(bot.channelGuildMap);
  console.log("å…¥ã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼:");
  var ServerList = client.guilds.map(a => a.name).join(" / ");
  console.log("[ " + ServerList + " ]");
  console.log("Ready!");
});

bot.on("voiceChannelJoin", (member, newChannel) => {
  const textChannel = newChannel.guild.channels.find(
    channel => (channel.type === 0, channel.name === "spam")
  );

  if (textChannel === undefined) {
    return;
  }

  if (member.nick === null) {
    bot.createMessage(
      textChannel.id,
      `ğŸ”¹ [ Join ]\nã€€ã€€ã€€**${member.username}**ï¼š **${newChannel.name}**`
    );
  } else {
    bot.createMessage(
      textChannel.id,
      `ğŸ”¹ [ Join ]\nã€€ã€€ã€€**${member.nick}**ï¼š **${newChannel.name}**`
    );
  }
});

bot.on("voiceChannelLeave", (member, oldChannel) => {
  const textChannel = oldChannel.guild.channels.find(
    channel => (channel.type === 0, channel.name === "spam")
  );

  if (textChannel === undefined) {
    return;
  }

  if (member.nick === null) {
    bot.createMessage(
      textChannel.id,
      `	ğŸ’¤ [ Leave ]\nã€€ã€€ã€€**${member.username}**`
    );
  } else {
    bot.createMessage(textChannel.id, `	ğŸ’¤ [ Leave ]\nã€€ã€€ã€€**${member.nick}**`);
  }
});

bot.on("voiceChannelSwitch", (member, newChannel, oldChannel) => {
  const textChannel = oldChannel.guild.channels.find(
    channel => (channel.type === 0, channel.name === "spam")
  );

  if (textChannel === undefined) {
    return;
  }

  if (member.nick === null) {
    bot.createMessage(
      textChannel.id,
      `ğŸ”¸ [ Move ]\nã€€ã€€ã€€**${member.username}**ï¼š **${oldChannel.name}**  >>  **${newChannel.name}**`
    );
  } else {
    bot.createMessage(
      textChannel.id,
      `ğŸ”¸ [ Move ]\nã€€ã€€ã€€**${member.nick}**ï¼š **${oldChannel.name}**  >>  **${newChannel.name}**`
    );
  }
});

// Botã‚’Discordã«æ¥ç¶š
bot.connect();

client.on("message", message => {
  if (message.author.bot) return; // botè‡ªèº«ã®ç™ºè¨€ã¯ç„¡è¦–

  if (message.content.includes("everyone")) return; // everyoneã‚’ç„¡è¦–

  // æ•—åŒ—è€…
  if (message.content.includes("æ•—åŒ—è€…")) {
    message.channel.send(
      "ãƒã‚¡...ãƒã‚¡...æ•—åŒ—è€…...?\nå–ã‚Šæ¶ˆã›ã‚ˆ...!!ä»Šã®è¨€è‘‰...!!"
    );
    return;
  }

  // mention
  if (message.isMemberMentioned(client.user)) {
    message.reply("å•é¡ŒãŒç™ºç”Ÿã—ãŸæ™‚ã¯ã€Noko#2123 ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (message.content.includes("è¨˜éŒ²")) {
    message.channel.send(
      "https://docs.google.com/spreadsheets/d/1yZkRn0KHqJjHKw3d3LSUEJCZt2WegybeTrMSfjyu0V0/edit#gid=56667276"
    );
    return;
  }

  if (message.content.startsWith("$")) {
    args = message.content
      .slice(prefix.length)
      .trim()
      .split(/ +/g);
    command = args.shift().toLowerCase();
  } else {
    args = 0;
    command = 0;
  }

  //Tenhou Reset Room ID
  if (command === "resetroom") {
    setroomid = null;
    message.channel.send("ãƒ«ãƒ¼ãƒ IDã®å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ");
    return;
  }

  //Tenhou Set Room ID

  var roomrep = message.content.replace(/^\$setroom /, "");

  if (command === "setroom") {
    if (
      roomrep >= 1000 &&
      roomrep <= 7999 &&
      roomrep.length === 4 && //æ–‡å­—æ•°æŒ‡å®š
      /\d{4}/.test(roomrep) && //æ­£è¦è¡¨ç¾(0x1F1Fã¿ãŸã„ãªã®ã¯ã˜ãã‚„ã¤)
      Number.isInteger(Number(roomrep)) //è‡ªç„¶æ•°ã®ã¿ã®ã‚„ã¤ï¼Ÿã—ã‚‰ã‚“ã‘ã©
    ) {
      setroomid = roomrep;
      message.channel.send("ãƒ«ãƒ¼ãƒ IDã‚’ " + setroomid + " ã«å›ºå®šã—ã¾ã—ãŸ");
      return;
    } else {
      message.channel.send(
        "ãƒ«ãƒ¼ãƒ IDã¯ åŠè§’æ•°å­—ã§ `1000 ~ 7999` ã®ä¸­ã‹ã‚‰æŒ‡å®šã—ã¦ãã ã•ã„"
      );
      return;
    }
  }

  //ãƒ©ãƒ³ãƒ€ãƒ 
  var roomidMIN = 1000;
  var roomidMAX = 7999;

  var roomid =
    Math.floor(Math.random() * (roomidMAX + 1 - roomidMIN)) + roomidMIN;

  //Tenhou room
  if (command === "room") {
    if (setroomid == null) {
      message.channel.send(
        "ãƒ«ãƒ¼ãƒ IDã¯ " +
          roomid +
          " ã§ã™\nå›ºå®šã™ã‚‹å ´åˆã¯ã€`$setroom " +
          roomid +
          "` ã¨å…¥åŠ›ã—ã¦ãã ã•ã„\nhttps://tenhou.net/0/?" +
          roomid
      );
      return;
    } else {
      message.channel.send(
        "ãƒ«ãƒ¼ãƒ IDã¯ " +
          setroomid +
          " ã§å›ºå®šä¸­ã§ã™\nå›ºå®šã‚’è§£é™¤ã™ã‚‹å ´åˆã¯ã€`$resetroom` ã¨å…¥åŠ›ã—ã¦ãã ã•ã„"
      );
      message.channel.send("https://tenhou.net/0/?" + setroomid);
      return;
    }
  }

  //ç¢ºèªç”¨
  if (command === "id") {
    message.channel.send("roomid: " + roomid + " | setroomid: " + setroomid);
    return;
  }

  //$rps
  if (command === "rps") {
    let replies = ["r", "p", "s"];
    let result = Math.floor(Math.random() * replies.length);

    let uReply = args[0];
    if (!uReply)
      return message.channel.send(
        `**$rps <?>**ã€€ã¨æ‰“ã£ã¦ãã ã•ã„ï¼š /n\`r (ã‚°ãƒ¼) , p (ãƒ‘ãƒ¼) , s (ãƒãƒ§ã‚­)\``
      );
    if (!replies.includes(uReply))
      return message.channel.send(
        `ã“ã®ä¸­ã‹ã‚‰ãˆã‚‰ã‚“ã§ãã ã•ã„ï¼š/n\`r (ã‚°ãƒ¼) , p (ãƒ‘ãƒ¼) , s (ãƒãƒ§ã‚­)\``
      );
    //rock
    else if (uReply === "r") {
      console.log(replies[result]);
      if (replies[result] === "r")
        return message.channel.send(
          "[YOU]   :right_facing_fist:  vs  :left_facing_fist:   [BOT]\nã€€ã€€ å¼•ãåˆ†ã‘ã§ï½ï½ã™"
        );
      if (replies[result] === "p")
        return message.channel.send(
          "[YOU]   :right_facing_fist:  vs  :raised_hand:   [BOT]\nã€€ã€€ ã‚ãªãŸã®è² ã‘ã§ã™"
        );
      else
        return message.channel.send(
          "[YOU]   :right_facing_fist:  vs  :metal:   [BOT]\nã€€ã€€ ã‚ãªãŸã®å‹ã¡ï¼"
        );
    }

    //paper
    else if (uReply === "p") {
      console.log(replies[result]);
      if (replies[result] === "p")
        return message.channel.send(
          "[YOU]   :raised_back_of_hand:  vs  :raised_hand:   [BOT]\nã€€ å¼•ãåˆ†ã‘ã§ï½ï½ï½ã™"
        );
      if (replies[result] === "s")
        return message.channel.send(
          "[YOU]   :raised_back_of_hand:  vs  :metal:   [BOT]\nã€€ ã‚ãªãŸã®è² ã‘ã§ï½ã™"
        );
      else
        return message.channel.send(
          "[YOU]   :raised_back_of_hand:  vs  :left_facing_fist:   [BOT]\nã€€ ã‚ãªãŸã®å‹ã¡ã§ã™ï¼"
        );
    }

    //scissors
    else if (uReply === "s") {
      console.log(uReply);
      console.log(replies[result]);
      if (replies[result] === "s")
        return message.channel.send(
          "[YOU]   :v:  vs  :metal:   [BOT]\nã€€ å¼•ãåˆ†ã‘ã§ï½ï½ï½ã™"
        );
      if (replies[result] === "r")
        return message.channel.send(
          "[YOU]   :v:  vs  :left_facing_fist:   [BOT]\nã€€ ã‚ãªãŸã®è² ã‘ã§ï½ã™"
        );
      else
        return message.channel.send(
          "[YOU]   :v:  vs  :raised_hand:   [BOT]\nã€€ ã‚ãªãŸã®å‹ã¡ã§ã™ï¼"
        );
    }
  }

  //cry
  if (command === "cry") {
    message.channel.send(
      "thunder, sword in his hand\nTitans of justice, fearless we stand\nCry thunder, strong in command\nBlessed by the union, freedom of man"
    );
    return;
  }

  //seasons
  if (command === "seasons") {
    message.channel.send(
      "The words are dying in the night\nNo winter lasts forever\nThe seasons pass and the sunlight will shine\nOn my life again\nSo let the past now burn down in flames"
    );
    return;
  }

  //uouo
  if (command === "uouo") {
    message.channel.send("â‚â‚â½â½:crab:â‚â‚â¾â¾ã‚¦ã‚ªã‚¦ã‚ª");
    return;
  }

  //huruete nemure
  if (command === "ãˆã¦çœ ã‚Œ") {
    message.channel.send("<:aaa:663688535236149271>");
    return;
  }

  //thinking pistol
  if (command === "suicide") {
    message.channel.send("<:thinkingpistol:663690728106360842>");
    return;
  }

  //usebrain
  if (command === "usebrain") {
    message.channel.send("<:usebrain:663690746192461824>");
    return;
  }

  //kawa nutte kawa kawa kono kawaranai hibi wo
  if (command === "kawa") {
    message.channel.send(
      "https://twitter.com/mahjong_megure/status/1205891322948673536?s=20"
    );
    return;
  }

  //kusoga
  if (command === "kusoga") {
    message.channel.send("ã‚¯ã‚½ã¨ã‹è¨€ã†ãªã‚¯ã‚½ãŒ");
    return;
  }

  //car
  if (command === "car") {
    message.channel
      .send("...............ğŸš—......")
      .then(Car => Car.edit("............ğŸš—........."))
      .then(Car => Car.edit("........ğŸš—............"))
      .then(Car => Car.edit(".....ğŸš—..............."))
      .then(Car => Car.edit("..ğŸš—.................."))
      .then(Car => Car.edit("ğŸš—...................."))
      .then(Car => Car.edit("ğŸ˜®....ğŸš—.............."))
      .then(Car => Car.edit(".ğŸ˜§..ğŸš—......................"))
      .then(Car => Car.edit("..:tired_face:.:red_car:......................"))
      .then(Car => Car.edit("...:ghost::red_car:......................"));
    return;
  }

  //bosyu

  if (command === "bosyu" && !RcheckOn) {
    message.channel.send("`$boend`ã§å‹Ÿé›†ã‚’çµ‚äº†ã—ã¾ã™")
    if (args[0] === undefined) {
      var bosyuTitle = "Users";
    } else {
      var bosyuTitle = args[0];
    }
    var RListOld = new RichEmbed().setTitle(bosyuTitle);
    RcheckOn = true;
    message.channel.send(RListOld).then(message => {
      message.react("ğŸ”¼");
      var messageId = 0;

      function addo(reaction, user) {
        if (user.bot) {
          messageId = message.id;
          return;
        }
        if (!user.bot && RcheckOn && reaction.message.id === messageId) {
          ReactuserList.push(user.username);
          var RListB = ReactuserList.join("\n");
          var RListNew = new RichEmbed()
            .setTitle(bosyuTitle)
            .setDescription(RListB);
          message.edit(RListNew);
        }
      }

      function remobe(reaction, user) {
        if (RcheckOn && reaction.message.id === messageId) {
          ReactuserList.splice(ReactuserList.indexOf(user.username), "1");
          var RListB = ReactuserList.join("\n");
          var RListNew = new RichEmbed()
            .setTitle(bosyuTitle)
            .setDescription(RListB);
          message.edit(RListNew);
        }
      }

      function stpo(message) {
        if (command === "boend") {
          if (message.author.bot) return;
          RcheckOn = false;
          ReactuserList.length = 0;
          client.removeListener("messageReactionAdd", addo);
          client.removeListener("messageReactionRemove", remobe);
          client.removeListener("message", stpo);
          message.channel.send("å‹Ÿé›†ã‚’åœæ­¢ã—ã¾ã™");
        }
      }

      client.on("messageReactionAdd", addo);

      client.on("messageReactionRemove", remobe);

      client.on("message", stpo);
    });
    return;
  }

  //test1ã€€éºç”£
  if (command === "test1") {
    message.channel
      .send({
        embed: {
          title: "éº»é›€ çµæœè¨˜éŒ²",
          fields: [
            {
              name: "å¯¾æˆ¦ã‚’ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„",
              value:
                ":one:ã€€ãˆãã‚ã‚\n:two:ã€€Noko\n:three:ã€€ã‚¢ã‚¯ã‚»ãƒ©\n:four:ã€€ã‚€ãã¡ã‚‡ã“\n:five:ã€€ã’ããŠã‚ãŸ\n:six:ã€€nuzojon\n:seven:ã€€IRK\n:eight:ã€€ã‚„ã¿ã†ã©ã‚“\n:nine:ã€€ã¡ã‚",
              inline: false
            }
          ]
        }
      })
      .then(message =>
        message
          .react("1ï¸âƒ£")
          .then(() => message.react("2ï¸âƒ£"))
          .then(() => message.react("3ï¸âƒ£"))
          .then(() => message.react("4ï¸âƒ£"))
          .then(() => message.react("5ï¸âƒ£"))
          .then(() => message.react("6ï¸âƒ£"))
          .then(() => message.react("7ï¸âƒ£"))
          .then(() => message.react("8ï¸âƒ£"))
          .then(() => message.react("9ï¸âƒ£"))
          .catch(e => message.channel.send("error"))
      );
    return;
  }

  //test2 ç©ºã
  if (command === "test2") {
    //here
    return;
  }

  //test3 ç©ºã
  if (command === "test3") {
    //here
    return;
  }

  //test4
  if (command === "test4") {
    //here
    return;
  }

  //test5 Embed Sample
  const EmbedSample = new RichEmbed()
    .setTitle("3")
    .setAuthor("3")
    .setDescription("33")
    .addField("3333", "33333333")
    .setImage("https://i.imgur.com/wSTFkRM.png")
    .setColor(8011653);

  if (command === "test5") {
    message.channel.send(EmbedSample);
    return;
  }

  //test6
  if (command === "test6") {
    //here
    return;
  }

  //help
  const Embednkhelp = new RichEmbed()
    .setTitle("ãƒ˜ãƒ«ãƒ—")
    .setDescription(
      "é€šè©±ã«å…¥é€€å‡ºã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ #spam ã§é€šçŸ¥ã—ã¾ã™\n#spam ã¨ã„ã†åå‰ã®ãƒãƒ£ãƒ³ãƒãƒ«ãŒãªã„å ´åˆã¯é€šçŸ¥ã—ã¾ã›ã‚“"
    )
    .addField("$nkcommand", "ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™")
    .addField("$nkstamp", "å®šå‹æ–‡ãƒ»çµµæ–‡å­—ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™")
    .setFooter("ãƒãƒ£ãƒƒãƒˆã«ã€Œæ•—åŒ—è€…ã€ã¨ã„ã†æ–‡å­—ã‚’æ··ãœã‚‹ã¨...?")
    .setColor(8011653);

  if (command === "nkhelp") {
    message.channel.send(Embednkhelp);
    return;
  }

  //help nkcommand
  const Embednkcmd = new RichEmbed()
    .setTitle("ã‚³ãƒãƒ³ãƒ‰")
    .addField("$rps [r/p/s]", "BOTã¨ã˜ã‚ƒã‚“ã‘ã‚“å‹è² ï¼")
    .addField("$cry", "Dragonforce - Cry Thunder ã‚’æ­Œã„ã¾ã™")
    .addField("$seasons", "Dragonforce - Seasons ã‚’æ­Œã„ã¾ã™")
    .addField("$car", "car")
    .addField("$room", "å¤©é³³ã®éƒ¨å±‹ã‚’ç”Ÿæˆã—ã¾ã™")
    .addField("$setroom", "å¤©é³³ã®ãƒ«ãƒ¼ãƒ IDã‚’å›ºå®šã—ã¾ã™")
    .addField("$resetroom", "ãƒ«ãƒ¼ãƒ IDã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™")
    .addField("$link", "ãƒªãƒ³ã‚¯é›†ã‚’è¡¨ç¤ºã—ã¾ã™")
    .addField("$nkcommand", "ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™")
    .addField("$nkstamp", "å®šå‹æ–‡ãƒ»çµµæ–‡å­—ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™")
    .addField("$bosyu <Title>", "å‹Ÿé›†ã‚’ã—ã¾ã™ ã‚¿ã‚¤ãƒˆãƒ«ã¯è‡ªç”±ã§ã™")
    .addField("$boend", "å‹Ÿé›†ã‚’çµ‚äº†ã—ã¾ã™")
    .setColor(8011653);

  if (command === "nkcommand") {
    message.channel.send(Embednkcmd);
    return;
  }

  //help nkstamp
  const Embednkstamp = new RichEmbed()
    .setTitle("å®šå‹æ–‡ãƒ»çµµæ–‡å­—")
    .addField("$ãˆã¦çœ ã‚Œ", "<:aaa:663688535236149271>")
    .addField("$suicide", "<:thinkingpistol:663690728106360842>")
    .addField("$usebrain", "<:usebrain:663690746192461824>")
    .addField("$kusoga", "ã‚¯ã‚½ãŒ")
    .addField("$kawa", "ï¾‰ï¾˜ å¡—ã£ã¦ ï¾‰ï¾˜ ï¾‰ï¾˜")
    .setColor(8011653);

  if (command === "nkstamp") {
    message.channel.send(Embednkstamp);
    return;
  }

  const Embednklink = new RichEmbed()
    .setTitle("ãƒªãƒ³ã‚¯é›†")
    .addField(
      "å£è‡­è­¦éƒ¨ éº»é›€éƒ¨ season 3",
      "[Here](https://docs.google.com/spreadsheets/d/1yZkRn0KHqJjHKw3d3LSUEJCZt2WegybeTrMSfjyu0V0/edit?usp=sharing)"
    )
    .addField(
      "Ultimate OX",
      "[Here](https://docs.google.com/spreadsheets/d/1N5RcAbM8mnGes76pdStNCrZF7ER5d-JgMyAr1Sr_irY/edit?usp=sharing)"
    )
    .addField(
      "åˆ¶é™ã—ã‚Šã¨ã‚Š",
      "[Here](https://docs.google.com/spreadsheets/d/1Y7I7XkcByjuFubB8giDKRaMe-yvUhRRV-7v1usx5WxE/edit?usp=sharing)"
    )
    .addField(
      "pp Calculator (ver.1.1)",
      "[Here](https://docs.google.com/spreadsheets/d/1_oLAI7-Ql53nNhpA4AyiqyIxJdZfUImUV2sXV9aE0yk/edit?usp=sharing)"
    )
    .addField(
      "helloSpreadSheet",
      "[ã“ã“](https://docs.google.com/spreadsheets/d/1sSqLnk_AuNj03O2hHhwSuQaX_tsDKHpby1wDdsNC2k4/edit#gid=0)[ã‚’](https://ja.uncyclopedia.info/wiki/%E3%82%92)[Here](https://docs.google.com/spreadsheets/d/1sSqLnk_AuNj03O2hHhwSuQaX_tsDKHpby1wDdsNC2k4/edit#gid=0)ï¼"
    )
    .addField("BoardGameArena", "[Here](https://ja.boardgamearena.com/)")
    .setColor(8011653);

  if (command === "link") {
    message.channel.send(Embednklink);
    return;
  }
});

if (process.env.DISCORD_BOT_TOKEN == undefined) {
  console.log("please set ENV: DISCORD_BOT_TOKEN");
  process.exit(0);
}

client.login(process.env.DISCORD_BOT_TOKEN);
